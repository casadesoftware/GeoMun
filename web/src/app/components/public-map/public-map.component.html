<div class="h-screen w-screen overflow-hidden bg-dark-900 flex flex-col">

  @if (loading()) {
    <div class="flex items-center justify-center h-full">
      <div class="flex flex-col items-center gap-3">
        <div class="w-10 h-10 border-2 border-primary-400 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-white/40 text-sm">Cargando mapa...</span>
      </div>
    </div>
  } @else if (error()) {
    <div class="flex items-center justify-center h-full px-4">
      <div class="glass p-8 text-center max-w-sm">
        <div class="text-4xl mb-3">üó∫Ô∏è</div>
        <p class="text-red-400 text-lg font-medium mb-2">{{ error() }}</p>
        <a href="/" class="text-primary-400 text-sm hover:text-primary-300 underline underline-offset-2">‚Üê Volver al inicio</a>
      </div>
    </div>
  } @else if (map()) {
    <!-- ===== VISTA DE MAPA INDIVIDUAL ===== -->
    <div class="flex-1 flex relative overflow-hidden">

      <!-- Overlay backdrop m√≥vil -->
      @if (sidebarOpen()) {
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 lg:hidden" (click)="sidebarOpen.set(false)"></div>
      }

      <!-- Panel lateral -->
      <aside [class]="'absolute lg:relative z-40 h-full flex flex-col transition-transform duration-300 ease-out ' +
        'w-72 sm:w-80 bg-dark-900/95 lg:bg-dark-900/80 backdrop-blur-xl border-r border-white/10 ' +
        (sidebarOpen() ? 'translate-x-0' : '-translate-x-full lg:translate-x-0')">

        <!-- Header del panel -->
        <div class="p-4 pb-3 border-b border-white/10">
          <div class="flex items-center justify-between mb-1">
            
            <button class="lg:hidden p-1.5 rounded-lg hover:bg-white/10 text-white/60" (click)="sidebarOpen.set(false)">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <h1 class="text-lg font-bold text-white leading-tight">{{ map().name }}</h1>
          @if (map().theme) {
            <span class="inline-block mt-1 text-xs px-2 py-0.5 rounded-full bg-primary-500/15 text-primary-300 border border-primary-500/20">{{ map().theme }}</span>
          }
        </div>

        <!-- Capas -->
        <div class="flex-1 overflow-y-auto p-4 pt-3">
          <p class="text-[10px] text-white/40 uppercase tracking-widest font-semibold mb-2">Capas</p>
          <div class="space-y-0.5">
            @for (layer of map().layers; track layer.id) {
              <button class="w-full flex items-center gap-2.5 py-2 px-2.5 rounded-lg transition-all text-left group"
                      [class]="layerVisibility()[layer.id] ? 'bg-white/5 hover:bg-white/10' : 'opacity-50 hover:opacity-70'"
                      (click)="toggleLayer(layer.id)">
                <div class="w-3 h-3 rounded-full shrink-0 ring-2 ring-offset-1 ring-offset-dark-900 transition-all"
                     [style.background-color]="layer.style?.color || '#3b82f6'"
                     [class]="layerVisibility()[layer.id] ? 'ring-white/30 scale-100' : 'ring-transparent scale-75'"></div>
                <span class="text-sm flex-1 truncate" [class]="layerVisibility()[layer.id] ? 'text-white' : 'text-white/40'">{{ layer.name }}</span>
                <span class="text-[10px] tabular-nums px-1.5 py-0.5 rounded bg-white/5 text-white/30 group-hover:text-white/50">{{ layer.features?.length || 0 }}</span>
              </button>
            } @empty {
              <p class="text-white/20 text-sm text-center py-6">Sin capas p√∫blicas</p>
            }
          </div>
        </div>

        <!-- Style selector en el panel -->
        <div class="p-4 pt-2 border-t border-white/10">
          <p class="text-[10px] text-white/40 uppercase tracking-widest font-semibold mb-2">Estilo de mapa</p>
          <div class="grid grid-cols-5 gap-1">
            @for (s of mapStyles; track s.id) {
              <button (click)="changeMapStyle(s.id)"
                      class="flex flex-col items-center gap-0.5 py-1.5 rounded-lg text-center transition-all"
                      [class]="currentStyle() === s.id ? 'bg-primary-500/20 ring-1 ring-primary-500/50' : 'hover:bg-white/5'"
                      [title]="s.name">
                <span class="text-base leading-none">{{ s.icon }}</span>
                <span class="text-[9px] text-white/40 truncate w-full">{{ s.name }}</span>
              </button>
            }
          </div>
        </div>
      </aside>

      <!-- Mapa -->
      <div class="flex-1 relative">
        <div #publicMapContainer class="absolute inset-0"></div>

        <!-- Bot√≥n hamburguesa para abrir sidebar (m√≥vil) -->
        @if (!sidebarOpen()) {
          <button (click)="sidebarOpen.set(true)"
                  class="absolute top-3 left-3 z-20 lg:hidden p-2.5 rounded-xl bg-dark-900/90 backdrop-blur-md border border-white/15 text-white shadow-lg shadow-black/30 hover:bg-dark-800 active:scale-95 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
        }

        <!-- Bot√≥n de ubicaci√≥n -->
        <button (click)="geolocate()"
                class="absolute z-20 p-2.5 rounded-xl bg-dark-900/90 backdrop-blur-md border border-white/15 text-white/70 hover:text-white shadow-lg shadow-black/30 hover:bg-dark-800 active:scale-95 transition-all"
                [class]="sidebarOpen() ? 'top-3 left-3 lg:bottom-20 lg:top-auto lg:left-3' : 'bottom-20 left-3'"
                title="Mi ubicaci√≥n">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0-6v2m0 16v2m8-10h2M2 12h2"/></svg>
        </button>

        <!-- Bot√≥n fit bounds -->
        <button (click)="fitToFeatures()"
                class="absolute z-20 p-2.5 rounded-xl bg-dark-900/90 backdrop-blur-md border border-white/15 text-white/70 hover:text-white shadow-lg shadow-black/30 hover:bg-dark-800 active:scale-95 transition-all"
                [class]="sidebarOpen() ? 'top-3 left-16 lg:bottom-20 lg:top-auto lg:left-16' : 'bottom-20 left-16'"
                title="Ver todo">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>

        <!-- Info features count (esquina inferior derecha) -->
        @if (map().layers?.length) {
          <div class="bottom-14 lg:bottom-3 right-3 z-20 px-3 py-1.5 rounded-full bg-dark-900/80 backdrop-blur-md border border-white/10 text-[11px] text-white/40">
            {{ getTotalFeatures() }} elementos ¬∑ {{ map().layers.length }} capas
          </div>
        }
      </div>
    </div>

  } @else {
    <!-- ===== CAT√ÅLOGO DE MAPAS P√öBLICOS ===== -->
    <nav class="px-4 sm:px-6 py-3 flex items-center justify-between border-b border-white/10 shrink-0">
      <a href="/" class="text-xl font-bold text-primary-400">PixelMapas.Online</a>
      <span class="text-xs sm:text-sm text-white/40 hidden sm:block">Informaci√≥n Geogr√°fica P√∫blica</span>
    </nav>

    <div class="flex-1 overflow-y-auto p-4 sm:p-6">
      <h1 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Mapas P√∫blicos</h1>

      @if (themes().length > 0) {
        <div class="flex gap-2 mb-4 sm:mb-6 flex-wrap">
          @for (theme of themes(); track theme) {
            <button (click)="filterByTheme(theme)"
                    [class]="selectedTheme() === theme ? 'btn-primary' : 'btn-secondary'"
                    class="text-sm">
              {{ theme }}
            </button>
          }
        </div>
      }

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        @for (m of filteredMaps(); track m.id) {
          <div class="glass p-4 sm:p-5 cursor-pointer hover:border-primary-500/50 transition-all active:scale-[0.98]" (click)="openMap(m.slug)">
            <h3 class="font-semibold mb-1">{{ m.name }}</h3>
            <p class="text-xs text-white/40">{{ m.theme }} ¬∑ {{ m._count?.layers || 0 }} capas</p>
          </div>
        } @empty {
          <div class="col-span-full glass p-8 text-center text-white/30">No hay mapas p√∫blicos disponibles</div>
        }
      </div>
    </div>
  }

  <!-- ===== LIGHTBOX DE IMAGEN ===== -->
  @if (lightboxUrl()) {
    <div class="fixed inset-0 z-[9999] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 cursor-zoom-out"
         (click)="lightboxUrl.set(null)">
      <button class="absolute top-4 right-4 p-2 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all"
              (click)="lightboxUrl.set(null)">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <img [src]="lightboxUrl()" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain cursor-default" (click)="$event.stopPropagation()" alt="Vista ampliada">
    </div>
  }
</div>
